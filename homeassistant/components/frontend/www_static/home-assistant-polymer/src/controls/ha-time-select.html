<link rel='import' href='../../bower_components/polymer/polymer.html'>
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-time-input/paper-time-input.html">

<dom-module id='ha-time-select'>
  <template>
    <style include="paper-material">
      :host {
        display: block;
        border-radius: 2px;
        transition: all 0.30s ease-out;
        padding:0 6px 0 6px;
        background-color: white;
      }
    </style>
      <span>
        <b>[[getItemLabel(item_label)]]</b>
      </span>
      <paper-time-input 
        on-change="updateSetting"
        value="[[getTimeValue(time_value)]]"
        hour="[[getHour(time_value)]]"
        min="[[getMin(time_value)]]"
        format="24"
        label=""></paper-time-input>
  </template>
</dom-module>
<script>
Polymer({
  is: 'ha-time-select',
  properties: {
    hass: {
      type: Object,
    },
    time_value: {
      type: String
    },
    state_obj: {
      type: Object,
      value: {}
    },
    update_method: {
      type: String,
      value: ''
    },
    item_prop: {
      type: String,
      value: ''
    },
    item_subprop: {
      type: String,
      value: ''
    },
    item_listprop: {
      type: String,
      value: ''
    },
    item_index: {
      type: Number
    },
    item_label: {
      type: String,
      value: ''
    },
  },
  ready: function () {
    // const timePicker = this.$$('#time-picker');
    // timePicker.addEventListener('value-changed', this.updateSetting.bind(this));
    // timePicker.time = moment(this.time_value).valueOf();
  },
  getItemLabel(itemValue) {
    const itemLabel = (itemValue ? itemValue + ":" : "");
    return itemLabel;
  },
  getTimeValue(timeValue) {
    const value = moment(timeValue).format();
    console.log(value);
    return value;
  },
  getHour(timeValue) {
    const value = moment(timeValue).format("H");
    console.log("hours:" + value);
    return value;
  },
  getMin(timeValue) {
    const value = moment(timeValue).format("mm");
    console.log("minutes: " + value);
    return value;
  },
  getAmPm(timeValue) {
    const value = moment(timeValue).format("A");
    console.log("am or pm: ", value);
    return value;
  },
  updateSetting: function (evt) {
    console.log("prop: " + this.item_prop);
    console.log("subprop: " + this.item_subprop);
    console.log("listprop: " + this.item_listprop);
    console.log("index: " + this.item_index);
    console.log("update method: " + this.update_method);
    console.log("value: " + evt.currentTarget.value);
    
    const timeInput = evt.currentTarget;
    const hour = timeInput.hour;
    const min = timeInput.min;

    const newTime = moment().set('hour', hour).set('minute', min);

    const prop = this.item_prop;
    const subprop = this.item_subprop;
    const listprop = this.item_listprop;
    const listindex = this.item_index;

    const updateObj = { 
      'target': prop,
      'subtarget': (subprop ? subprop : 'value'),
      'value': newTime.format() 
    };

    if (listprop)
    {
      updateObj.listtarget = listprop;
      updateObj.listindex = listindex;
    }
    
    if (this.update_method)
    {
      this.callServiceHelper(this.update_method, updateObj);
    }
  },
  callServiceHelper: function (service, data) {
    if (this.hass)
    {      
      this.hass.callService(this.state_obj._domain, service, { value: data})
        .then(function () {
        }.bind(this));
    }
  }
  

});


</script>
