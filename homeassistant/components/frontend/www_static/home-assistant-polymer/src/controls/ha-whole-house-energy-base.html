<link rel='import' href='../../bower_components/polymer/polymer.html'>
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel='import' href='./ha-hems-comparer.html'>
<link rel='import' href='./ha-hems-benefit-comparer.html'>


<dom-module id='ha-whole-house-energy-base'>
  <template>
    <style is="custom-style" include="iron-flex"></style>
    <style>
      :host {
        position: relative;
      }
      .states {
        padding-bottom: 16px;
      }
      .state {
        padding: 4px 16px;
      }
      td, th {
        padding-right: 8px;
      }
      .state .label {
        color: rgba(0, 0, 0, 0.54);
        font-weight: bold;
        text-transform: capitalize;
      }
      .state .value {
        color: rgba(0, 0, 0, 0.87);
      }
      .header {
        @apply(--paper-font-headline);
        /* overwriting line-height +8 because entity-toggle can be 40px height,
           compensating this with reduced padding */
        line-height: 40px;
        color: var(--primary-text-color);
        padding: 20px 16px 20px;
        background-color: #fff176
      }
      .header .name {
        @apply(--paper-font-common-nowrap);
      }
      .header.domain .name {
        /* Capitalize cards titles for default domain groups. */
        text-transform: capitalize;
      }
      .comparer-container {
        width: 400px;
        height: 160px;
        flex-direction: column;
        justify-content: space-between;
        display: flex;
      }
      .comparer-container > div {
        display: block;
        text-align: center;
        margin-bottom: 10px;
        white-space: nowrap;
      }
      .comparer-container > div > * {
        display: inline-block;
        vertical-align: bottom;
      }
      .outlook-label {
        color: dimgray;
        font-size: 16px;
        font-weight: bold;
        padding-left: 10px;
        margin-top: 10px;
      }
      .toggle-container {
        font-size: 14px;
        padding-left: 10px;
        height: 40px;
        display: inline;
        margin-top: 10px;
      }
      .color-box {
        height: 10px;
        width: 10px;
      }
      .color-box.estimate {
        background: repeating-linear-gradient(
          45deg,
          forestgreen,
          forestgreen 2px,
          transparent 2px,
          transparent 4px
        );
      }
      .color-box.goal {
        background-color: #3b92ef;
      }
      .color-box.actual {
        background-color: #2db72d;
      }
      .legend {
        font-size: 14px;
        line-height: 14px;
        float: right;
      }
      .your-money {
        float: right;
        border: 2px solid gray;
        font-size: 14px;
        padding: 20px;
        margin-right: 10px;
      }
      .your-money > .amount {
        font-weight: bold;
        color: green;
      }
      .content {
        padding: 4px 30px 30px;
        background-color: #ffffa8;
      }

    </style>
    <div class="header domain">
      <div class="name">[[card_name]]</div>
    </div>
    <div class="content">
      <div class="outlook-label">Today's Outlook</div>
      <div class="legend">
        <table>
          <tbody>
            <tr>
              <td>
                <div class="color-box estimate"></div>
              </td>
              <td>
                estimate (from HEMS)
              </td>
            </tr>
            <tr>
              <td>
                <div class="color-box goal"></div>
              </td>
              <td>
                [[getGoalLabel(state_obj)]]
              </td>
            </tr>
            <template is="dom-if" if="[[getAttributesFromLabel(state_obj, 'Actual', 'value')]]">
              <tr>
                <td>
                  <div class="color-box actual"></div>
                </td>
                <td>
                  actual (from meter)
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <div class="comparer-container">
        <div></div>
        <div>
          <ha-hems-comparer 
            estimate_label="[[getAttributes(state_obj, 'energyReductionEstimate', 'value')]]"
            goal_label="[[getAttributes(state_obj, 'energyReductionGoal', 'value')]]"
            actual_label="[[getAttributes(state_obj, 'energyReductionActual', 'value')]]"
            units_label="[[getAttributes(state_obj, 'energyReductionEstimate', 'units')]]"
            item_label="energy reduction"
            background_style="[[getUseOutlookStyle(state_obj)]]"
            max_value="[[max_reduction]]"
          ></ha-hems-comparer>
          <ha-hems-benefit-comparer 
            compensation_estimate_label="[[getAttributes(state_obj, 'compensationEstimate', 'value')]]"
            compensation_goal_label="[[getAttributes(state_obj, 'compensationGoal', 'value')]]"
            savings_estimate_label="[[getAttributes(state_obj, 'savingsEstimate', 'value')]]"
            savings_goal_label="[[getAttributes(state_obj, 'savingsGoal', 'value')]]"
            background_style="[[getUseOutlookStyle(state_obj)]]"
            max_value="[[max_money]]"
          ></ha-hems-benefit-comparer>
        </div>
      </div>
      <div class="your-money">
        <span class="dollar-signs">Total estimated benefit</span>: 
        $[[getTotalBenefit()]]
      </div>
      <div class="toggle-container">
        <template is="dom-if" if="[[state_obj.attributes.canToggle]]">
          <paper-toggle-button raised
            on-change="useOutlook"
            checked="[[getAttributes(state_obj, 'useAlgorithm', 'value')]]"
            data-prop="useAlgorithm"
          >
            [[getToggleLabel(state_obj)]]
          </paper-toggle-button>
        </template>
      </div>
    </div>
  </template>
</dom-module>

<script>
Polymer({
  is: 'ha-whole-house-energy-base',
  properties: {
    hass: {
      type: Object,
      observer: 'updateMaxes'
    },
    state_obj: {
      type: Object
    },
    groupEntity: {
      type: Object,
    },
    useLabel: {
      type: String,
      value: "Opting in"
    },
    notUseLabel: {
      type: String,
      value: "Opting out"
    },
    compensation_or_savings: {
      type: String
    },
    background_color: {
      type: String
    },
    update_method: {
      type: String
    },
    update_platform: {
      type: String
    },
    other_method: {
      type: String
    },
    other_platform: {
      type: String
    },
    max_reduction: {
      type: Number
    },
    max_money: {
      type: Number
    }
  },
  updateMaxes: function () {
      this.setMaxReduction();
      this.setMaxMoney();
  },
  setMaxReduction: function () {
      let max = 0;

      if (this.hass)
      {
          const maxes = [];

          const wholeHouseEnergy = this.hass.states["whole_house_energy.whole_house_energy"].attributes;

          if (wholeHouseEnergy.energyReductionActual)
          {
            maxes.push(Number(wholeHouseEnergy.energyReductionActual.value));
          }

          if (wholeHouseEnergy.energyReductionEstimate)
          {
            maxes.push(Number(wholeHouseEnergy.energyReductionEstimate.value));
          }

          if (wholeHouseEnergy.energyReductionGoal)
          {
            maxes.push(Number(wholeHouseEnergy.energyReductionGoal.value));
          }

          max = Math.max(...maxes);
      }

      this.max_reduction = max;
  },
  setMaxMoney: function () {
      let max = 0;

      if (this.hass)
      {
          const maxes = [];

          const wholeHouseEnergy = this.hass.states["whole_house_energy.whole_house_energy"].attributes;

          const estimateTotal = this.getTotal(wholeHouseEnergy, 'Estimate');

          maxes.push(estimateTotal);

          const goalTotal = this.getTotal(wholeHouseEnergy, 'Goal');

          maxes.push(goalTotal);

          max = Math.max(...maxes);
      }

      this.max_money = max;
  },
  getTotal: function (obj, catagory) {
      let total = 0;

      total = this.addToTotal(total, 'compensation' + catagory, obj);
      total = this.addToTotal(total, 'savings' + catagory, obj);

      return total;
  },
  addToTotal: function (total, attr, obj) {
      let newTotal = total;

      if (obj[attr])
      {
        newTotal = newTotal + Number(this.convertNumber(obj[attr].value));
      }

      return newTotal;
  },
  convertNumber: function (str) {
      const num = (str[0] === "$" ? Number(str.substring(1)) : Number(str));
      return num;
  },
  getTotalBenefit: function () {
    const compensation = this.convertNumber(this.state_obj.attributes.compensationEstimate.value);

    const savings = this.convertNumber(this.state_obj.attributes.savingsEstimate.value);

    return compensation + savings;
  },
  getLabel: function (labelType) {
    const prefix = this.compensation_or_savings;
    return `${prefix}${labelType}`;
  },
  useOutlook: function (evt) {
      const checked = evt.target.checked;
      const prop = evt.currentTarget.dataset.prop;

      this.updateSetting(checked, prop, this.update_method, this.update_platform);
      // this.updateSetting(!checked, prop, this.other_method, this.other_platform);
  },
  getToggleLabel: function (stateObj) {
      let toggleLabel = "";

      if (stateObj)
      {
          const useOutlook = stateObj.attributes.useAlgorithm.value;
          toggleLabel = (useOutlook ? this.useLabel : this.notUseLabel);
      }
      
      return toggleLabel;
  },
  getUseOutlookStyle: function (stateObj) {
      let useOutlookStyle = "";

      // if (stateObj)
      // {
      //     const useOutlook = stateObj.attributes.useAlgorithm.value;
      //     useOutlookStyle = (!useOutlook ? "background-color: lightgray" : '');
      // }
      
      return useOutlookStyle;
  },
  getAttributes: function (obj, attr, subattr) {
    let value = '';

    if (obj.attributes.hasOwnProperty(attr) && obj.attributes[attr].hasOwnProperty(subattr))
    {
      value = obj.attributes[attr][subattr];
    }

    return value;
  },
  getAttributesFromLabel: function (obj, attr, subattr) {
    let value = '';

    const fullAttr = this.compensation_or_savings + attr;

    if (obj.attributes.hasOwnProperty(fullAttr) && obj.attributes[fullAttr].hasOwnProperty(subattr))
    {
        value = obj.attributes[fullAttr][subattr];
    }
    
    return value;
  },
  getGoalLabel: function (obj) {
      return obj.attributes.goalLegendLabel;
  },
  updateSetting: function (newValue, prop, method, platform) {
      const updateObj = { 
        'target': prop,
        'subtarget': 'value',
        'value': newValue 
      };
        
      this.callServiceHelper(method, updateObj, platform);
  },
  callServiceHelper: function (service, data, platform) {
    if (this.hass)
    {      
      this.hass.callService(platform, service, { value: data})
        .then(function () {
          // console.log('successful service call');
        }.bind(this));
    }
  }
});
</script>
