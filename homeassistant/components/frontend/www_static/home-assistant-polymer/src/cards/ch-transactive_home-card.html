<link rel='import' href='../../bower_components/polymer/polymer.html'>
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel='import' href='../components/ha-card.html'>
<link rel="import" href='../components/ch-charts-container.html'>
<link rel='import' href='../controls/ch-progress-scale.html'>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<link href="../../bower_components/toastr/toastr.css" rel="stylesheet"/>
<script src="../../bower_components/toastr/toastr.js"></script>

<dom-module id='ch-transactive_home-card'>
  <template>
    <style is="custom-style" include="iron-flex"></style>
    <style>
      .state {
        padding: 0 16px;
      }
      td, th {
        padding-right: 8px;
      }
      .state .label {
        color: rgba(0, 0, 0, 0.54);
      }
      .state .value {
        color: rgba(0, 0, 0, 0.87);
      }
      .header {
        @apply(--paper-font-headline);
        /* overwriting line-height +8 because entity-toggle can be 40px height,
           compensating this with reduced padding */
        line-height: 40px;
        color: var(--primary-text-color);
        padding: 20px 16px 12px;
      }
      .header .name {
        @apply(--paper-font-common-nowrap);
      }
      .header.domain .name {
        /* Capitalize cards titles for default domain groups. */
        text-transform: capitalize;
      }
      .progress-container {
        position: relative;
        padding: 30px 30px 10px 30px;
        display: block;
        text-align: center;
      }
      .progress-bar {
        display: inline-block;
        margin: 0 10px;
        width: 100%;
      }
      .progress-start,
      .progress-end {
        z-index: 200;
        font-size: 12px;
        color: #4f4f52;        
        line-height: 12px;
        text-align: center;
        display: inline-block;
      }
      .progress-message {
        --paper-tooltip-background: cadetblue;
        --paper-tooltip-opacity: 1;
      }
      #toast-container > .toast {
        background-image: none !important;
      }
      .popup {
        max-width:600px !important;
      }
      .show{
        font-size: 10px;
        margin-top: 15px;
        padding: 5px;
      }
      .show-hide-chart {
        width: 100%;
        text-align: right;
        position: relative;
        min-height: 60px;
        margin-top: 60px;
      }
      .show-hide-chart paper-fab {
        right: 40px;
        position: absolute;
        z-index: 2;
      }
      .yearly-text {
        padding-left: 40px;
        padding-right: 40px;
      }
      .yearly-text > div {
        max-width: 40%;
      }
      .yearly-text > div:first-child {
        float: left;
        text-align: left;
      }
      .yearly-text > div:not(first-child) {
        float: right;
        text-align: right;
        clear: right;
      }
      .state th:first-child {
        border-top: 1px solid lightgray;
        padding: 0;
        margin: 0;
        box-sizing: border-box;
      }
      .current-state {
        display: inline-block;
      }
    </style>
    <ha-card class='transactive-home'>
      <div class='header domain'>
        <div class='name'>[[stateObj.attributes.friendly_name]]</div>
      </div>
      <div class='current-state'>
        <div class='state'>
          Today (as of now)
        </div>
        <table class='state'>
          <thead>
            <tr>
              <th colspan=2><th>
            </tr>
          </thead>
          <tbody>
            <template is='dom-repeat' items="[[getList(stateObj)]]">
              <tr>
                <td class='label'>[[item.label]]</td>
                <td class='value'>[[item.value]] [[item.unit]]</td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
      <div class='progress-container'>
          <div>
            Yearly Savings
          </div>
          <div class='progress-bar'>
            <ch-progress-scale 
              id="overall-progress"
              hass="[[hass]]"
              state_obj="[[stateObj]]"
              update_method="update_transactive_home"
              right_value="$[[getProgressEnd(stateObj)]]"
              left_value="$[[getProgressStart(stateObj)]]"
              actual_value="$[[getProgressValue(stateObj)]]"
              description="[[progressMessage]]"
              item_prop="progress_bar"
              right_prop="end_point"
            ></ch-progress-scale>
          </div>
      </div>
      <div class="yearly-text">
        <div>
          <span class="label">[[stateObj.attributes.progress_bar.lastYearLabel]]:&nbsp;</span>
          <span>[[formatMoney(stateObj.attributes.progress_bar.last_year)]]</span>
        </div>
        <div>
          <span>[[getPercentSavings(stateObj)]]%&nbsp;</span>
          <span class="label">[[stateObj.attributes.progress_bar.comparisonLabel]]</span>
        </div>
      </div>
      <div class="show-hide-chart">
        <paper-fab
          mini
          on-click="showHideChart"
          icon="mdi:chart-line"
        ></paper-fab>
        <div class='data-chart' hidden$="{{hidden}}">
          <ch-charts-container
            state-obj="[[stateObj]]"
            card_width="[[cardWidth]]"
            aggregation="true">
          </ch-charts-container>
        </div>
      </div>
    </ha-card>
  </template>
</dom-module>
<script>
Polymer({
  is: 'ch-transactive_home-card',
  properties: {
    hass: {
      type: Object,
    },
    stateObj: {
      type: Object,
    },
    groupEntity: {
      type: Object,
    },
    hidden:{
      type: Boolean,
      value: true
    },
    messageOptions: {
      type: Array,
      value: [
        "You're off to a good start.",
        "You're making good progress.",
        "Halfway through, keep up the good work!",
        "Look at that, you're almost there!",
        "Congratulations! You reached your goal."
      ]
    },
    progressMessage: {
      type: String,
      computed: 'getProgressMessage(stateObj)'
    },
    cardWidth: {
      type: Number
    }
  },
  ready: function() {
      try {
        this.cardWidth = this.getClientRects()[1].width;
      }
      catch(e) {

      }
  },
  getPercentSavings: function (obj) {
      const lastYear = obj.attributes.progress_bar.last_year;
      const goal = obj.attributes.progress_bar.end_point;
      const percentSavings = Math.round(goal / lastYear * 100);

      return percentSavings;
  },
  showHideChart: function() {
    this.hidden = !this.hidden;
  },
  formatMoney: function (value) {
    return value.toLocaleString('en-US', {
      style: 'currency',
      currency: 'USD'
    });
  },
  getList: function (obj) {
    // this.showToastMessage("Hi, your HVAC isn't in transactive mode for 10 days. Simply turn it back on and start saving energy and money again.");
    // this.showToastMessage("Hi, you'll be on vacation next week. It's a good time to maximize savings. Want to set your house to minimum energy mode?");
    // this.showToastMessage("Hi, we just found a new device that can be part of your home transactive energy network. Want to add it in and start saving energy and money now?");
    return obj.attributes.measures;
  },

  getProgressStart: function(obj){

    let progressStart = null;

    if (obj.attributes.hasOwnProperty('progress_bar'))
    {
        progressStart = obj.attributes.progress_bar.starting_point;
    }

    return progressStart;
  },

  getProgressEnd: function(obj){
    let progressEnd = null;

    if (obj.attributes.hasOwnProperty('progress_bar'))
    {
        progressEnd = obj.attributes.progress_bar.end_point;
    }

    return progressEnd;
  },

  getProgressValue: function(obj) {
    let progressValue = null;

    if (obj.attributes.hasOwnProperty('progress_bar'))
    {
        progressValue = obj.attributes.progress_bar.value;
    }

    return progressValue;
  },

  getProgressMessage: function(obj) {

    let message = '';

    if (obj.attributes.hasOwnProperty('progress_bar')){
      const progressBar = obj.attributes.progress_bar;

      const value = progressBar.value;

      const min = progressBar.starting_point;
      const max = +progressBar.end_point;
      const range = max - min;

      if (range > 0)
      {
        if (value > min)
        {
          const zeroScaleValue = value - min;

          const ratio = zeroScaleValue / range;

          const optionsLength = this.messageOptions.length - 1;

          if (ratio >= 1)
          {
            message = this.messageOptions[optionsLength];
          }
          else
          {
            let i;
            for (i = 0; i <= optionsLength; i++)
            {
                if (ratio >= (i / optionsLength))
                {
                  message = this.messageOptions[i];
                }
            }
          }
        }
        else
        {
          message = this.messageOptions[0];
        }
      }
      else
      {
        message = "Unable to determine progress: invalid range."
      }
    }

    return message;
  },

  showToastMessage: function (message) {
    toastr.options = {
      "closeButton": false,
      "debug": false,
      "newestOnTop": true,
      "progressBar": false,
      "positionClass": "toast-bottom-right",
      "preventDuplicates": false,
      "onclick": null,
      "showDuration": "300",
      "hideDuration": "1000",
      "timeOut": "0",
      "extendedTimeOut": "1000",
      "showEasing": "swing",
      "hideEasing": "linear",
      "showMethod": "fadeIn",
      "hideMethod": "fadeOut"
    }
    // toastr.info(message);

    toastr["info"]("<div>" + message + "</div>");
  },
  callServiceHelper: function (service, data) {
    if (this.hass)
    {      
      this.hass.callService('transactive_home', service, { value: data})
        .then(function () {
        }.bind(this));
    }
  },
});
</script>